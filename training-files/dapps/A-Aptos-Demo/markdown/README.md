# Developing Aptos Decentralized Applications using the dddappp Low-Code Tool

English | [ä¸­æ–‡](README_CN.md)

## Prerequisites

Currently, the dddappp low-code tool is published as a Docker image for developers to experience.

The off-chain services generated by the tool are written in Java and use the MySQL database by default.

So before getting started, you need to:

* Install [Aptos CLI](https://aptos.dev/tools/install-cli/).

* Install [Docker](https://docs.docker.com/engine/install/).

* ~~Install MySQL database server.ðŸ‘ˆ Since the generation of off-chain services is currently under development, you can ignore this step for now.~~

* ~~Install JDK and Maven. The off-chain services generated by the tool currently use Java.ðŸ‘ˆ Since the generation of off-chain services is currently under development, you can ignore this step for now.~~

If you have already installed Docker, you can use Docker to run a MySQL database service. For example:

```shell
sudo docker run -p 3306:3306 --name mysql \
-v ~/docker/mysql/conf:/etc/mysql \
-v ~/docker/mysql/logs:/var/log/mysql \
-v ~/docker/mysql/data:/var/lib/mysql \
-e MYSQL_ROOT_PASSWORD=123456 \
-d mysql:5.7
```


## Example: Reproduce the Development Process of the Demo Application

We have placed a Demo application developed using the dddappp low-code tool on GitHub. The application code is divided into two parts (TODO aptos-java-service...):

* Aptos Move on-chain contracts: https://github.com/wubuku/Dapp-LCDP-Demo/tree/main/aptos_contracts

* ~~Java off-chain service: https://github.com/wubuku/Dapp-LCDP-Demo/tree/main/aptos-java-service~~

You can follow the instructions below to reproduce the development process of this Demo.

### Write DDDML Model Files

You can create a directory, for example, called `test`, to place all the application code, and then create a subdirectory `dddml` within this directory. We generally put the model files written according to the DDDML specification in this directory.

You can download/copy the sample model files here to the `dddml` directory: https://github.com/wubuku/Dapp-LCDP-Demo/tree/main/domain-model/aptos

In these models, some of the fabricated examples may have become a bit "absurdly" complicated, but our tool is not "stumped".


### Run dddappp Project Creation Tool

Use Docker to run the project creation tool:

```shell
docker run \
-v /PATH/TO/test:/myapp \
wubuku/dddappp-aptos:0.0.1 \
--dddmlDirectoryPath /myapp/dddml \
--boundedContextName Test.AptosTestProj1 \
--boundedContextJavaPackageName org.test.aptostestproj1 \
--boundedContextAptosPackageName AptosTestProj1 \
--boundedContextAptosNamedAddress aptos_test_proj1 \
--javaProjectsDirectoryPath /myapp/aptos-java-service \
--javaProjectNamePrefix aptostestproj1 \
--pomGroupId test.aptostestproj1 \
--aptosMoveProjectDirectoryPath /myapp/aptos-contracts
```

The command parameters above are straightforward:

* Note that `/PATH/TO/test` should be replaced with the path of your local directory where you actually place the application code. This line indicates mounting your local directory into the `/myapp` directory inside the container.
* `dddmlDirectoryPath` is the directory where DDDML model files are located. It should be a readable directory path in the container.
* Interpret the value of parameter `boundedContextName` as the name of your application you want to develop. When there are multiple parts in your name, separate them with dots and use PascalCase naming style for each part. Bounded-context is a term in Domain-driven design (DDD) that refers to a specific problem domain scope that contains specific business boundaries, constraints, and language. If you don't understand this concept for now, it's not a big deal.
* `boundedContextJavaPackageName` is Java package name of off-chain service. According to Java naming conventions, it should be all lowercase and parts should be separated by dots.
* `boundedContextAptosPackageName` is package name of on-chain Aptos contracts. It's recommended to use PascalCase naming style.
* `boundedContextAptosNamedAddress` is default named address of on-chain Aptos contracts. It's recommended to use snake_case naming style.
* `javaProjectsDirectoryPath` is directory path where off-chain service code is placed. Off-chain service consists of multiple modules (projects). It should be a readable and writable directory path in container.
* `javaProjectNamePrefix` is name prefix of each module of off-chain service. It's recommended to use an all-lowercase name.
* `pomGroupId` is GroupId of off-chain service. We use Maven as project management tool for off-chain service. It should be all lowercase and parts should be separated by dots.
* `aptosMoveProjectDirectoryPath` is directory path where on-chain Aptos contract code is placed. It should be a readable and writable directory path in container.

After executing above command successfully, a directory `aptos-contracts` should be added to local directory `/PATH/TO/test`.

~~(TODO aptos-java-service...)~~

~~Now you can try to compile off-chain service. Go to directory aptos-java-service and run: `mvn compile`~~

~~If there is no unexpected failure, compilation should be successful.~~

Now, on-chain contracts cannot be compiled because "business logic" has not been implemented yet. Next, we will implement them.

#### About the generated on-chain contract code

Note that the current generated on-chain contract code saves the state of the aggregate root entity (such as the `Order` entity of the `Order` aggregate) in a Table.

### Implementing Business Logic

The tool has generated some files ending with `_logic.move` in the directory `aptos-contracts/sources`. The files contain scaffold code for functions that implement business logic, i.e., the signature part of the functions. Now you just need to fill in the implementation part of the functions.

You can consider copying the implementation code of the business logic that has been written from here: https://github.com/wubuku/Dapp-LCDP-Demo/tree/main/aptos-contracts/sources

You can also clone the code repository of this Demo application and execute a shell script like the following to complete the copy work (note to replace `_PATH_TO_/Dapp-LCDP-Demo` and `_PATH_TO_/test` with the actual paths on your machine):


```shell
#!/bin/bash

source_dir="_PATH_TO_/Dapp-LCDP-Demo/aptos-contracts/sources"
target_dir="_PATH_TO_/test/aptos-contracts/sources"

old_keyword="aptos_demo"
new_keyword="aptos_test_proj1"

for file in "${source_dir}"/*_logic.move; do
  if [[ -f "$file" ]] && grep -q "$old_keyword" "$file"; then
    cp "$file" "${target_dir}/$(basename "$file")"
    sed -i "" "s/$old_keyword/$new_keyword/g" "${target_dir}/$(basename "$file")"
  fi
done
```

---

#### Some preparatory work that may need to be done

It should be noted that below we assume that you will publish the Move contract to the Aptos devnet, so we skip the explanation of the modifications to some configuration files required for publishing to other networks.

Confirm that Aptos CLI is installed and enter the directory `aptos-contracts`:

```shell
aptos init
# Press Enter to confirm using the default values
aptos account fund-with-faucet --account default --amount 50000000000
```

View Aptos Profiles:

```shell
aptos config show-profiles
```

---

#### Compile Apots Move contracts

In the directory `aptos-contracts`, execute the compilation, which should now succeed:

```shell
aptos move compile --named-addresses aptos_test_proj1=default
```

At this point, the coding phase of the application development is complete! Isn't it very simple?

---

Next, we will deploy and test the Demo application.

### Publish Aptos Contracts

After completing the writing of the business logic, execute the following command in the directory `aptos-contracts` to publish the contract to the chain:

```shell
aptos move publish --named-addresses aptos_test_proj1=default
```

[TBD]

### TODO Off-chain Java Service `aptos-java-service`

~~The configuration items that need to be set to run the off-chain Java service:~~

~~* The address where the contract is deployed. Note that currently, after deploying and calling the initialization method of the contract, a resource account will be generated.~~

~~* The BaseURL of the Node API of the network used (nonsense).~~

~~The Aptos Node API interfaces that the off-chain Java service depends on:~~

* [Get events by event handle](https://fullnode.devnet.aptoslabs.com/v1/spec#/operations/get_events_by_event_handle). Use this interface to get information about the creation of resource accounts, various domain events, etc.
* [Get account resource](https://fullnode.devnet.aptoslabs.com/v1/spec#/operations/get_account_resource). Use this interface to get information about the resources under an account. The handle of the Table that stores the aggregate root state needs to be obtained using this interface.
* [Get table item](https://fullnode.devnet.aptoslabs.com/v1/spec#/operations/get_table_item). Use this interface to get the state of the aggregate root entity (such as the order entity in the Order aggregate) and the internal entities in the aggregate (such as OrderItem, i.e., order item entity in the Order aggregate).


## Some tips

### Clean Up Exited Docker Containers

Execute command:

```shell
docker rm $(docker ps -aq --filter "ancestor=wubuku/dddappp-aptos:0.0.1")
```

